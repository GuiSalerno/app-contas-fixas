<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minhas Contas Fixas</title>
    <!-- Inclui Tailwind CSS para estilização rápida e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Define a fonte Inter para todo o documento -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Fundo cinza claro */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Alinha o conteúdo ao topo */
            min-height: 100vh; /* Altura mínima de 100% da viewport */
            padding: 2rem 1rem; /* Espaçamento interno */
            box-sizing: border-box; /* Inclui padding na largura/altura total */
        }
    </style>
    <!-- Vincula o arquivo CSS personalizado -->
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="container bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Minhas Contas Fixas</h1>

        <!-- Informações do Usuário Logado -->
        <div id="userInfo" class="bg-indigo-50 p-4 rounded-lg mb-6 text-center hidden">
            <p class="text-indigo-800 text-lg font-semibold mb-2 flex items-center justify-center">
                <img id="userPhoto" src="" alt="Foto de Perfil" class="w-8 h-8 rounded-full mr-2 hidden">
                Olá, <span id="userName" class="ml-1"></span>!
            </p>
            <button id="signOutBtn"
                    class="bg-red-500 text-white text-sm py-2 px-4 rounded-lg hover:bg-red-600 transition duration-300">
                Sair
            </button>
        </div>

        <!-- Botão de Login com Google -->
        <div id="loginSection" class="mb-6">
            <button id="signInGoogleBtn"
                    class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-md flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12.24 10.27v2.44h6.81a6.05 6.05 0 0 1-2.61 3.96l2.13 1.66A9.95 9.95 0 0 0 22 12c0-2.37-.62-4.57-1.7-6.43l-2.16 1.69a6.05 6.05 0 0 1 2.87 4.77z" fill="#4285F4"/>
                    <path d="M3 12c0 2.37.62 4.57 1.7 6.43l2.16-1.69a6.05 6.05 0 0 1-2.87-4.77H3z" fill="#34A853"/>
                    <path d="M10 21.92a9.95 9.95 0 0 0 7.82-3.8l-2.13-1.66a6.05 6.05 0 0 1-7.82 1.48L10 21.92z" fill="#FBBC04"/>
                    <path d="M12 4.08a9.95 9.95 0 0 0-7.82 3.8l2.13 1.66a6.05 6.05 0 0 1 7.82-1.48L12 4.08z" fill="#EA4335"/>
                </svg>
                Entrar com Google
            </button>
        </div>

        <!-- Formulário para adicionar nova conta -->
        <div id="addAccountSection" class="mb-6 bg-blue-50 p-4 rounded-lg hidden">
            <h2 class="text-lg font-semibold text-blue-800 mb-3">Adicionar Nova Conta</h2>
            
            <input type="text" id="novaContaInput" placeholder="Nome da conta (ex: Aluguel)"
                   class="w-full p-3 mb-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <div class="flex mb-3 space-x-2">
                <input type="number" step="0.01" id="valorContaInput" placeholder="Valor (R$)"
                       class="w-1/2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select id="periodicidadeSelect"
                        class="w-1/2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Periodicidade</option>
                    <option value="mensal">Mensal</option>
                    <option value="semanal">Semanal</option>
                    <option value="anual">Anual</option>
                    <option value="unica">Única</option>
                </select>
            </div>

            <h3 class="text-md font-medium text-blue-700 mb-2">Categoria</h3>
            <div class="mb-3">
                <select id="categoriaContaSelect"
                        class="w-full p-3 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">Selecione uma Categoria</option>
                    <!-- Categorias serão carregadas aqui pelo JS -->
                </select>
                <div class="flex space-x-2">
                    <input type="text" id="novaCategoriaInput" placeholder="Nova Categoria"
                           class="w-2/3 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="adicionarCategoriaBtn"
                            class="w-1/3 bg-gray-500 text-white font-bold py-3 rounded-lg hover:bg-gray-600 transition duration-300 shadow-md text-sm">
                        Criar
                    </button>
                </div>
            </div>
            
            <button id="adicionarContaBtn"
                    class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                Adicionar Conta
            </button>
        </div>

        <!-- Lista de Contas -->
        <div id="accountsListSection" class="hidden">
            <h2 class="text-lg font-semibold text-gray-700 mb-3">Contas Cadastradas</h2>
            <ul id="listaContas" class="space-y-3">
                <!-- As contas serão carregadas aqui pelo JavaScript -->
                <li class="bg-gray-50 p-4 rounded-lg text-gray-600 text-center">Nenhuma conta adicionada ainda.</li>
            </ul>
        </div>
        
        <!-- Área para mensagens do usuário -->
        <div id="mensagem" class="mt-6 p-3 rounded-lg text-center font-medium hidden"></div>
        
        <!-- Indicador de carregamento -->
        <div id="loadingIndicator" class="mt-6 text-center text-blue-600 font-semibold hidden">
            Carregando...
        </div>
    </div>

    <!-- Inclui os SDKs do Firebase -->
    <script type="module">
        // Importa os módulos necessários do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, deleteDoc, doc, query, where, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // VAI AQUI SEU CÓDIGO firebaseConfig REAL! SUBSTITUA ESTE BLOCO ABAIXO.
        const firebaseConfig = {
            apiKey: "AIzaSyBqTtAkHKAeFhYRFLeIRGU_X0nH2_4Xn90",
            authDomain: "bill-management13.firebaseapp.com",
            projectId: "bill-management13",
            storageBucket: "bill-management13.firebasestorage.app",
            messagingSenderId: "450207477897",
            appId: "1:450207477897:web:da67957b579b7b0e1e1658",
            measurementId: "G-MGLNZ8JZ1J"
        };
        // FIM DO BLOCO A SER SUBSTITUÍDO

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider(); // Provedor de autenticação Google

        // Referência para a coleção de contas no Firestore
        const contasCollectionRef = collection(db, "contasFixas");
        // Referência para a coleção de categorias PERSONALIZADAS (será por usuário)
        let categoriasPersonalizadasCollectionRef; // Será inicializada após o login

        // Categorias Padrão (diretamente no código)
        const defaultCategories = [
            'Moradia', 'Transporte', 'Alimentação', 'Contas (Água, Luz, Internet)',
            'Saúde', 'Educação', 'Lazer', 'Investimentos', 'Outros'
        ];

        // Elementos da UI
        const novaContaInput = document.getElementById('novaContaInput');
        const valorContaInput = document.getElementById('valorContaInput');
        const periodicidadeSelect = document.getElementById('periodicidadeSelect');
        const categoriaContaSelect = document.getElementById('categoriaContaSelect');
        const novaCategoriaInput = document.getElementById('novaCategoriaInput');
        const adicionarCategoriaBtn = document.getElementById('adicionarCategoriaBtn');
        const adicionarContaBtn = document.getElementById('adicionarContaBtn');
        const listaContas = document.getElementById('listaContas');
        const mensagemDiv = document.getElementById('mensagem');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const signInGoogleBtn = document.getElementById('signInGoogleBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const userInfoDiv = document.getElementById('userInfo');
        const userNameSpan = document.getElementById('userName');
        const userPhotoImg = document.getElementById('userPhoto');
        const loginSection = document.getElementById('loginSection');
        const addAccountSection = document.getElementById('addAccountSection');
        const accountsListSection = document.getElementById('accountsListSection');

        let userId = null; // Variável para armazenar o ID do usuário

        // Função para formatar valor em R$
        const formatarValorEmReal = (valor) => {
            if (typeof valor !== 'number') return 'R$ 0,00';
            return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        };

        // Função para exibir mensagens ao usuário
        function exibirMensagem(texto, tipo = 'info') {
            mensagemDiv.textContent = texto;
            mensagemDiv.classList.remove('hidden', 'bg-red-200', 'text-red-800', 'bg-green-200', 'text-green-800', 'bg-blue-200', 'text-blue-800');
            if (tipo === 'erro') {
                mensagemDiv.classList.add('bg-red-200', 'text-red-800');
            } else if (tipo === 'sucesso') {
                mensagemDiv.classList.add('bg-green-200', 'text-green-800');
            } else { // info
                mensagemDiv.classList.add('bg-blue-200', 'text-blue-800');
            }
            mensagemDiv.style.display = 'block';
            setTimeout(() => {
                mensagemDiv.classList.add('hidden');
            }, 3000);
        }

        // --- Autenticação com Google ---
        signInGoogleBtn.addEventListener('click', async () => {
            try {
                loadingIndicator.classList.remove('hidden');
                await signInWithPopup(auth, provider);
                // No onAuthStateChanged lidaremos com o usuário logado
            } catch (error) {
                console.error("Erro no login com Google:", error);
                if (error.code === 'auth/popup-closed-by-user') {
                    exibirMensagem("Login cancelado pelo usuário.", "info");
                } else {
                    exibirMensagem("Erro ao fazer login com Google. Tente novamente.", "erro");
                }
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

        // --- Logout ---
        signOutBtn.addEventListener('click', async () => {
            try {
                loadingIndicator.classList.remove('hidden');
                await signOut(auth);
                exibirMensagem("Você foi desconectado.", "sucesso");
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
                exibirMensagem("Erro ao fazer logout. Tente novamente.", "erro");
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

        // --- Listener para o estado de autenticação (onAuthStateChanged) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid; // Define o ID do usuário logado
                console.log("Usuário autenticado:", userId);

                // Inicializa a coleção de categorias PERSONALIZADAS para este usuário
                categoriasPersonalizadasCollectionRef = collection(db, `categorias/${userId}/minhasCategorias`);

                // Mostra informações do usuário e esconde o botão de login
                userInfoDiv.classList.remove('hidden');
                loginSection.classList.add('hidden');
                addAccountSection.classList.remove('hidden');
                accountsListSection.classList.remove('hidden');

                userNameSpan.textContent = user.displayName || 'Usuário';
                if (user.photoURL) {
                    userPhotoImg.src = user.photoURL;
                    userPhotoImg.classList.remove('hidden');
                } else {
                    userPhotoImg.classList.add('hidden');
                }

                carregarCategorias(); // Carrega TODAS as categorias (padrão + personalizadas)
                carregarContas(); // Carrega as contas do usuário logado
            } else {
                userId = null;
                console.log("Nenhum usuário autenticado.");

                // Esconde informações do usuário e mostra o botão de login
                userInfoDiv.classList.add('hidden');
                loginSection.classList.remove('hidden');
                addAccountSection.classList.add('hidden');
                accountsListSection.classList.add('hidden');
                
                // Limpa as categorias e as contas
                categoriaContaSelect.innerHTML = '<option value="">Selecione uma Categoria</option>';
                listaContas.innerHTML = '<li class="bg-gray-50 p-4 rounded-lg text-gray-600 text-center">Por favor, faça login para gerenciar suas contas.</li>';
            }
        });

        // --- Gerenciar Categorias Personalizadas ---
        adicionarCategoriaBtn.addEventListener('click', async () => {
            const nomeCategoria = novaCategoriaInput.value.trim();
            if (nomeCategoria === '') {
                exibirMensagem("Por favor, digite o nome da nova categoria.", "info");
                return;
            }
            if (!userId) {
                exibirMensagem("Você precisa estar logado para adicionar categorias.", "erro");
                return;
            }

            // Verifica se a categoria já existe nas padrão ou personalizadas
            const categoriaExistente = Array.from(categoriaContaSelect.options).some(
                option => option.value.toLowerCase() === nomeCategoria.toLowerCase()
            );

            if (categoriaExistente) {
                exibirMensagem("Esta categoria já existe.", "info");
                return;
            }

            try {
                loadingIndicator.classList.remove('hidden');
                // Adiciona a categoria na subcoleção PERSONALIZADA do usuário
                await addDoc(categoriasPersonalizadasCollectionRef, {
                    nome: nomeCategoria,
                    createdAt: new Date(),
                    userId: userId // Por redundância, já que está em subcoleção do user
                });
                novaCategoriaInput.value = '';
                exibirMensagem("Categoria adicionada com sucesso!", "sucesso");
            } catch (e) {
                console.error("Erro ao adicionar categoria: ", e);
                exibirMensagem("Erro ao adicionar categoria. Tente novamente.", "erro");
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

        // --- Carregar Categorias (Padrão + Personalizadas) ---
        function carregarCategorias() {
            if (!userId || !categoriasPersonalizadasCollectionRef) return;

            categoriaContaSelect.innerHTML = '<option value="">Selecione uma Categoria</option>'; // Limpa e adiciona opção padrão
            
            // Adiciona as categorias padrão
            defaultCategories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoriaContaSelect.appendChild(option);
            });

            // Carrega e adiciona as categorias personalizadas do usuário
            onSnapshot(categoriasPersonalizadasCollectionRef, (snapshot) => {
                // Remove apenas as categorias personalizadas antigas antes de adicionar as novas,
                // mantendo as padrão que já foram adicionadas
                Array.from(categoriaContaSelect.options).forEach(option => {
                    if (!defaultCategories.includes(option.value) && option.value !== '') {
                        option.remove();
                    }
                });

                snapshot.forEach(doc => {
                    const categoria = doc.data();
                    // Verifica se já não é uma categoria padrão para evitar duplicatas
                    if (!defaultCategories.includes(categoria.nome)) {
                        const option = document.createElement('option');
                        option.value = categoria.nome;
                        option.textContent = categoria.nome;
                        categoriaContaSelect.appendChild(option);
                    }
                });
            }, (error) => {
                console.error("Erro ao carregar categorias personalizadas:", error);
                exibirMensagem("Erro ao carregar categorias personalizadas.", "erro");
            });
        }


        // --- Adicionar Nova Conta ---
        adicionarContaBtn.addEventListener('click', async () => {
            const nomeConta = novaContaInput.value.trim();
            const valorConta = parseFloat(valorContaInput.value); // Converte para número
            const categoriaSelecionada = categoriaContaSelect.value;
            const periodicidadeSelecionada = periodicidadeSelect.value;

            if (nomeConta === '') {
                exibirMensagem("Por favor, digite o nome da conta.", "info");
                return;
            }
            if (isNaN(valorConta) || valorConta <= 0) {
                exibirMensagem("Por favor, insira um valor válido para a conta.", "info");
                return;
            }
            if (categoriaSelecionada === '') {
                exibirMensagem("Por favor, selecione ou crie uma categoria.", "info");
                return;
            }
            if (periodicidadeSelecionada === '') {
                exibirMensagem("Por favor, selecione a periodicidade da conta.", "info");
                return;
            }
            if (!userId) {
                exibirMensagem("Você precisa estar logado para adicionar contas.", "erro");
                return;
            }

            try {
                loadingIndicator.classList.remove('hidden');
                await addDoc(contasCollectionRef, {
                    nome: nomeConta,
                    valor: valorConta, // Salva o valor como número
                    categoria: categoriaSelecionada,
                    periodicidade: periodicidadeSelecionada,
                    paga: false, // Nova conta sempre começa como não paga
                    createdAt: new Date(), // Adiciona um timestamp para ordenação
                    userId: userId // Vincula a conta ao ID do usuário logado
                });
                // Limpa os inputs
                novaContaInput.value = '';
                valorContaInput.value = '';
                categoriaContaSelect.value = ''; // Reseta para a opção padrão
                periodicidadeSelect.value = ''; // Reseta para a opção padrão
                exibirMensagem("Conta adicionada com sucesso!", "sucesso");
            } catch (e) {
                console.error("Erro ao adicionar documento: ", e);
                exibirMensagem("Erro ao adicionar conta. Tente novamente.", "erro");
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        });

        // --- Carregar e Atualizar Contas em Tempo Real ---
        function carregarContas() {
            if (!userId) {
                listaContas.innerHTML = '<li class="bg-gray-50 p-4 rounded-lg text-gray-600 text-center">Por favor, faça login para gerenciar suas contas.</li>';
                return;
            }

            loadingIndicator.classList.remove('hidden');
            // A query filtra as contas pelo userId e ordena pela data de criação
            const userContasQuery = query(contasCollectionRef, where("userId", "==", userId), orderBy("createdAt", "asc"));

            onSnapshot(userContasQuery, (snapshot) => {
                listaContas.innerHTML = ''; // Limpa a lista existente
                const contas = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    contas.push({ id: doc.id, ...data });
                });

                if (contas.length === 0) {
                     listaContas.innerHTML = '<li class="bg-gray-50 p-4 rounded-lg text-gray-600 text-center">Nenhuma conta adicionada para você ainda.</li>';
                }

                contas.forEach(conta => {
                    const li = document.createElement('li');
                    li.className = `flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 rounded-lg transition duration-200 ${conta.paga ? 'bg-green-100' : 'bg-white shadow-sm'}`;
                    li.innerHTML = `
                        <div class="flex items-center mb-2 sm:mb-0 w-full sm:w-auto">
                            <input type="checkbox" id="conta-${conta.id}" ${conta.paga ? 'checked' : ''}
                                class="form-checkbox h-5 w-5 text-blue-600 rounded focus:ring-blue-500 cursor-pointer">
                            <label for="conta-${conta.id}" class="ml-3 text-lg ${conta.paga ? 'line-through text-gray-500' : 'text-gray-800'} cursor-pointer">
                                ${conta.nome}
                            </label>
                        </div>
                        <div class="flex flex-col sm:flex-row sm:items-center text-sm text-gray-500 w-full sm:w-auto mt-2 sm:mt-0">
                            <span class="sm:mr-3 mb-1 sm:mb-0 text-gray-700"><strong>${formatarValorEmReal(conta.valor)}</strong></span>
                            <span class="sm:mr-3 mb-1 sm:mb-0 text-gray-600">(${conta.categoria})</span>
                            <span class="capitalize sm:mr-3 mb-1 sm:mb-0 text-gray-600">${conta.periodicidade}</span>
                            <button data-id="${conta.id}" class="excluir-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50 transition duration-300">
                                <!-- Ícone de lixeira SVG de Lucide React, adaptado para HTML -->
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-2">
                                    <path d="M3 6h18"/>
                                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                                    <line x1="10" x2="10" y1="11" y2="17"/>
                                    <line x1="14" x2="14" y1="11" y2="17"/>
                                </svg>
                            </button>
                        </div>
                    `;
                    listaContas.appendChild(li);

                    // Adicionar evento para marcar/desmarcar
                    li.querySelector(`#conta-${conta.id}`).addEventListener('change', async (e) => {
                        const docRef = doc(db, "contasFixas", conta.id);
                        try {
                            loadingIndicator.classList.remove('hidden');
                            await updateDoc(docRef, {
                                paga: e.target.checked
                            });
                            exibirMensagem(e.target.checked ? "Conta marcada como paga!" : "Conta desmarcada.", "sucesso");
                        } catch (error) {
                            console.error("Erro ao atualizar status: ", error);
                            exibirMensagem("Erro ao atualizar conta. Tente novamente.", "erro");
                        } finally {
                            loadingIndicator.classList.add('hidden');
                        }
                    });

                    // Adicionar evento para excluir
                    li.querySelector('.excluir-btn').addEventListener('click', async (e) => {
                        const idParaExcluir = e.currentTarget.dataset.id;
                        const docRef = doc(db, "contasFixas", idParaExcluir);
                        try {
                            loadingIndicator.classList.remove('hidden');
                            await deleteDoc(docRef);
                            exibirMensagem("Conta excluída com sucesso!", "sucesso");
                        } catch (error) {
                            console.error("Erro ao excluir conta: ", error);
                            exibirMensagem("Erro ao excluir conta. Tente novamente.", "erro");
                        } finally {
                            loadingIndicator.classList.add('hidden');
                        }
                    });
                });
                loadingIndicator.classList.add('hidden');
            }, (error) => {
                console.error("Erro ao carregar contas:", error);
                exibirMensagem("Erro ao carregar contas. Verifique sua conexão.", "erro");
                loadingIndicator.classList.add('hidden');
            });
        }
    </script>
</body>
</html>
